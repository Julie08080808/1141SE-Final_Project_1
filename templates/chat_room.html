<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>å°ˆæ¡ˆè¨è«–å®¤ - æš¨æŸ´å·¥ä½œå§”è¨—å¹³å°</title>
<style>
  /* --- ğŸ¨ æ²¿ç”¨ä½ çš„ä¸»é¡Œè®Šæ•¸ --- */
  :root {
    --pink-light: #FFE6EB;
    --pink-nav: #FFC8D0;
    --theme-red: #FF4B6E;
    --text: #2a2a2a;
    --white: #FFFFFF;
    --border-color: #DDD;
  }

  body {
    font-family: "Noto Sans TC", sans-serif;
    background-color: var(--pink-light);
    margin: 0; padding: 0; color: var(--text);
  }

  /* ç°¡æ˜“å°è¦½åˆ— */
  header {
    background-color: var(--pink-nav);
    padding: 15px 40px;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  }
  header h2 { margin: 0; color: var(--theme-red); }
  
  /* è¿”å›æŒ‰éˆ• */
  .btn-back {
    background-color: var(--theme-red); color: white; text-decoration: none;
    padding: 8px 14px; border-radius: 8px; font-weight: bold;
  }

  /* --- ğŸ’¬ èŠå¤©å®¤å®¹å™¨ --- */
  .chat-container {
    max-width: 800px;
    margin: 30px auto;
    background: var(--white);
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    display: flex; flex-direction: column;
    height: 80vh; /* å›ºå®šé«˜åº¦è®“å®ƒé•·å¾—åƒèŠå¤©è»Ÿé«” */
    overflow: hidden;
  }

  .chat-header {
    padding: 20px; border-bottom: 1px solid #eee; background: #fff0f3;
  }
  
  .chat-header-content {
    display: flex; justify-content: space-between; align-items: center;
  }

  .chat-header h1 { margin: 0; font-size: 20px; color: var(--text); }
  .chat-header p { margin: 5px 0 0; font-size: 13px; color: #666; }

  /* è¨Šæ¯é¡¯ç¤ºå€ */
  .messages-area {
    flex: 1;
    overflow-y: auto; /* åªæœ‰é€™å€å¡Šæœƒæ²å‹• */
    padding: 20px;
    background-color: #f9f9f9;
    display: flex; flex-direction: column; gap: 15px;
  }

  /* è¨Šæ¯æ³¡æ³¡æ¨£å¼ */
  .message {
    max-width: 70%; padding: 12px 16px; border-radius: 15px;
    font-size: 15px; line-height: 1.5; position: relative;
    word-wrap: break-word; /* é˜²æ­¢é•·å–®å­—ç ´ç‰ˆ */
  }
  
  .message-meta {
    font-size: 12px; margin-bottom: 4px; display: block;
  }

  /* å°æ–¹çš„è¨Šæ¯ (å·¦é‚Š) */
  .msg-other {
    align-self: flex-start;
    background-color: #e9e9eb; color: #000;
    border-bottom-left-radius: 2px;
  }
  .msg-other .message-meta { color: #666; }

  /* æˆ‘çš„è¨Šæ¯ (å³é‚Š) */
  .msg-self {
    align-self: flex-end;
    background-color: var(--theme-red); color: white;
    border-bottom-right-radius: 2px;
  }
  .msg-self .message-meta { color: #ffccd5; text-align: right; }

  /* è¼¸å…¥æ¡†å€åŸŸ */
  .input-area {
    padding: 20px; background: white; border-top: 1px solid #eee;
  }
  
  .input-form { display: flex; gap: 10px; }
  
  .input-field {
    flex: 1; padding: 12px; border: 1px solid #ccc;
    border-radius: 20px; outline: none; font-size: 15px;
  }
  
  .btn-send {
    background-color: var(--theme-red); color: white; border: none;
    padding: 0 25px; border-radius: 20px; cursor: pointer; font-weight: bold;
  }
  .btn-send:hover { background-color: #e04063; }

</style>
</head>
<body>

<header>
  <h2>ğŸ’¬ å°ˆæ¡ˆæºé€šå®¤</h2>
  
  {% if current_user.user_type.strip() == 'client' %}
    <a href="/client/project/{{ project.id }}/manage" class="btn-back">â¬… è¿”å›å°ˆæ¡ˆ</a>
  {% else %}
    <a href="/contractor/project/{{ project.id }}/threads" class="btn-back">â¬… è¿”å›è¨è«–åˆ—è¡¨</a>
  {% endif %}
</header>

<main class="chat-container">
  <div class="chat-header">
    <div class="chat-header-content">
      <div>
        <h1>
          {% if thread.status == 'resolved' %}âœ… [å·²è§£æ±º] {% endif %}
          è¨è«–ä¸»é¡Œï¼š{{ thread.title }}
        </h1>
        <p>å°ˆæ¡ˆï¼š{{ project.title }}</p>
      </div>
      
      {% if current_user.user_type.strip() == 'client' and thread.status == 'open' %}
        <form action="/client/project/{{ project.id }}/thread/{{ thread.id }}/resolve" method="post" style="margin:0;">
          <button type="submit" style="background-color: #28a745; border: none; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">
            âœ… è¨­ç‚ºå·²è§£æ±ºä¸¦çµæŸè¨è«–
          </button>
        </form>
      {% endif %}
    </div>
  </div>

  <div class="messages-area">
    {% for msg in messages %}
      {% if msg.sender_id == current_user.uid %}
        <div class="message msg-self">
          <span class="message-meta">æˆ‘ - {{ msg.created_at.strftime('%m-%d %H:%M') }}</span>
          {{ msg.content }}
        </div>
      {% else %}
        <div class="message msg-other">
          <span class="message-meta">{{ msg.sender_name }} - {{ msg.created_at.strftime('%m-%d %H:%M') }}</span>
          {{ msg.content }}
        </div>
      {% endif %}
    {% else %}
      <p style="text-align:center; color:#999; margin-top:50px;">ç›®å‰é‚„æ²’æœ‰å°è©±ï¼Œé–‹å§‹è¨è«–å§ï¼</p>
    {% endfor %}
    
    {% if thread.status == 'resolved' %}
      <div style="text-align: center; margin-top: 20px; color: #28a745;">
        <hr style="border:0; border-top:1px dashed #ccc;">
        <p style="font-weight:bold; margin-top:15px;">ğŸ‰ æ­¤è­°é¡Œå·²è¢«å§”è¨—äººæ¨™è¨˜ç‚ºã€Œå·²è§£æ±ºã€ã€‚</p>
      </div>
    {% endif %}
  </div>

  {% if thread.status == 'open' and project.status.strip() != 'completed' %}
    <div class="input-area">
      {% if current_user.user_type.strip() == 'client' %}
        <form class="input-form" action="/client/project/{{ project.id }}/thread/{{ thread.id }}/send" method="post">
      {% else %}
        <form class="input-form" action="/contractor/project/{{ project.id }}/thread/{{ thread.id }}/send" method="post">
      {% endif %}
      
        <input type="text" name="content" class="input-field" placeholder="è¼¸å…¥è¨Šæ¯..." required autocomplete="off">
        <button type="submit" class="btn-send">å‚³é€</button>
      </form>
    </div>
  {% else %}
    <div class="input-area" style="background-color: #f0f0f0; text-align: center; color: #888; border-top: 1px solid #ddd;">
      {% if project.status.strip() == 'completed' %}
        ğŸ”’ æ­¤å°ˆæ¡ˆå·²æ­£å¼çµæ¡ˆï¼Œæ‰€æœ‰è¨è«–å·²å‡çµã€‚
      {% else %}
        ğŸ”’ æ­¤è¨è«–ä¸²å·²æ¨™è¨˜ç‚ºè§£æ±ºï¼Œç„¡æ³•å†å‚³é€è¨Šæ¯ã€‚
      {% endif %}
    </div>
  {% endif %}
</main>

<script>
  // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
  var msgArea = document.querySelector('.messages-area');
  msgArea.scrollTop = msgArea.scrollHeight;
</script>

</body>
</html>