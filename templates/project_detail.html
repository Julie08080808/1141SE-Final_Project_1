<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æš¨æŸ´å·¥ä½œå§”è¨—å¹³å°</title>
<style>
  :root {
    --pink: #FFB7C3;
    --pink-light: #FFE4E1;
    --theme: #FF5E7E;
    --gray: #f4f4f4;
    --text: #333;
  }
  body { font-family: "Noto Sans TC", sans-serif; background-color: var(--pink-light); color: var(--text); margin: 0; padding: 0; }
  header { background-color: var(--pink); color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  header a { color: white; text-decoration: none; font-weight: bold; }
  header a:hover { text-decoration: underline; }
  main { max-width: 900px; margin: 40px auto; background-color: white; border-radius: 15px; padding: 30px 40px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  h1 { color: var(--theme); margin-top: 0; }
  h2, h3 { color: var(--theme); }
  .project-meta { background-color: #fff6f8; border: 1px solid #f2c7d1; border-radius: 10px; padding: 20px; margin-top: 10px; }
  .project-meta p { margin: 6px 0; }
  .project-meta a { color: var(--theme); text-decoration: none; }
  .project-meta a:hover { text-decoration: underline; }
  .bid-form { margin-top: 30px; background-color: #fdf2f5; border-radius: 10px; padding: 20px 30px; border: 1px solid #f4c4d3; }
  .bid-form h2 { margin-top: 0; color: var(--theme); }
  .already-bid { margin-top: 30px; background-color: #e8f5e9; border-radius: 10px; padding: 20px 30px; border: 1px solid #4caf50; }
  .already-bid h2 { margin-top: 0; color: #2e7d32; }
  .info-box { background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 15px 20px; margin: 15px 0; }
  .info-box p { margin: 8px 0; color: #856404; }
  .info-box strong { color: #664d03; }
  label { display: block; font-weight: bold; margin-bottom: 6px; }
  input[type="number"], input[type="file"], textarea { width: 100%; max-width: 400px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; outline: none; transition: border-color 0.3s; box-sizing: border-box; }
  input:focus, textarea:focus { border-color: var(--theme); }
  button { background-color: var(--theme); color: white; border: none; border-radius: 10px; padding: 12px 18px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.3s; }
  button:hover { background-color: #ff7b9d; }
  hr { border: 0; border-top: 1px solid #eee; margin: 25px 0; }
  .deliverables-list { margin-top: 20px; list-style-type: none; padding-left: 0; }
  .deliverables-list li { background: #f9f9f9; padding: 10px 15px; border-radius: 5px; margin-bottom: 8px; border: 1px solid #eee; }
  .deliverables-list small { color: #777; }
  .deliverables-list p { margin-left: 10px; font-style: italic; color: #555; margin-top: 5px; margin-bottom: 5px; }
  .warning-text { color: #666; font-size: 14px; margin-top: 10px; padding: 10px; background-color: #fff9e6; border-left: 3px solid #ffc107; border-radius: 5px; }
</style>
</head>
<body>

<header>
  <h2>ğŸ’¼ ææ¡ˆå¹³å°</h2>
  <a href="{% if user.user_type.strip() == 'contractor' %}/contractor/dashboard{% else %}/client/dashboard{% endif %}">è¿”å›å„€è¡¨æ¿</a>
</header>

<main>
  <h1>{{ project.title }}</h1>

  <div class="project-meta">
    <p><strong>å§”è¨—äºº:</strong> {{ project.client_name.strip() }}</p>
    <p><strong>é ç®—:</strong> ${{ "%.2f"|format(project.budget) }}</p>
    <p><strong>ç‹€æ…‹:</strong> {{ project.status.strip() }}</p>
    <p><strong>æˆªæ­¢æ—¥æœŸ:</strong> {{ project.deadline.strftime('%Y-%m-%d') if project.deadline else 'N/A' }}</p>
  </div>
  
  <hr>
  
  <h3>ğŸ“‹ å°ˆæ¡ˆæè¿°</h3>
  <p>{{ project.description | safe | replace('\n', '<br>') }}</p>
  
  {% if project.attachment_url %}
  <p>
    <strong>å°ˆæ¡ˆé™„ä»¶:</strong>
    <a href="{{ project.attachment_url }}" target="_blank">
      ğŸ“ é»æ­¤ä¸‹è¼‰é™„ä»¶
    </a>
  </p>
  {% endif %}
  
  <hr>

  {% if user.user_type.strip() == 'client' and user.uid == project.client_id %}
    <div class="admin-links">
        <h2>ğŸ“Š å°ˆæ¡ˆç®¡ç†</h2>
        <p>é€™æ˜¯ä½ çš„å°ˆæ¡ˆ,ä½ å¯ä»¥ <a href="/client/project/{{ project.id }}/manage">é»æ­¤ç®¡ç†æŠ•æ¨™èˆ‡é©—æ”¶</a>ã€‚</p>
    </div>
  
  {% elif user.user_type.strip() == 'contractor' and project.status.strip() == 'in_progress' and user.uid == project.accepted_contractor_id %}
    <div class="bid-form">
      <h2>ğŸ† äº¤ä»˜ä½ çš„æˆæœ</h2>
      
      {% if deliverables %}
        <p>ä»¥ä¸‹æ˜¯ä½ ã€Œå·²äº¤ä»˜/è¢«é€€ä»¶ã€çš„ç´€éŒ„:</p>
        <ul class="deliverables-list">
        {% for d in deliverables %}
          <li>
            <a href="{{ d.file_url }}" target="_blank">
              ğŸ“ {{ d.file_url.split('/')[-1] }}
            </a>
            <br>
            <small>ç‹€æ…‹: <strong style="color:red">{{ d.status.strip() }}</strong> ({{ d.created_at.strftime('%Y-%m-%d') }})</small>
            <p>"{{ d.note }}"</p>
          </li>
        {% endfor %}
        </ul>
        <hr>
        <p><strong>ä½ çš„æª”æ¡ˆè¢«é€€ä»¶äº†,è«‹é‡æ–°ä¸Šå‚³:</strong></p>
      {% else %}
        <p>æ­å–œä½ !ä½ æ˜¯é€™å€‹å°ˆæ¡ˆçš„å¾—æ¨™è€…ã€‚è«‹åœ¨æ­¤ä¸Šå‚³ä½ çš„çµæ¡ˆæª”æ¡ˆã€‚</p>
      {% endif %}

      <form action="/contractor/project/{{ project.id }}/deliver" method="post" enctype="multipart/form-data">
        <div>
          <label for="file">äº¤ä»˜æª”æ¡ˆ:</label>
          <input type="file" id="file" name="file" required>
        </div>
        <div>
          <label for="note">å‚™è¨» (é¸å¡«):</label>
          <textarea id="note" name="note" rows="4"></textarea>
        </div>
        <button type="submit">æäº¤æª”æ¡ˆ</button>
      </form>
    </div>
  
  {% elif user.user_type.strip() == 'contractor' and project.status.strip() not in ['open', 'in_progress'] and user.uid == project.accepted_contractor_id %}
    <div class="bid-form">
      <h2>âœ… ä½ çš„äº¤ä»˜ç´€éŒ„</h2>
      <p>ä½ æ˜¯é€™å€‹å°ˆæ¡ˆçš„å¾—æ¨™è€…ã€‚ä»¥ä¸‹æ˜¯ä½ çš„äº¤ä»˜ç´€éŒ„:</p>
      
      {% if deliverables %}
        <ul class="deliverables-list">
        {% for d in deliverables %}
          <li>
            <a href="{{ d.file_url }}" target="_blank">
              ğŸ“ {{ d.file_url.split('/')[-1] }}
            </a>
            <br>
            <small>ç‹€æ…‹: <strong style="color:green">{{ d.status.strip() }}</strong> ({{ d.created_at.strftime('%Y-%m-%d') }})</small>
            <p>"{{ d.note }}"</p>
          </li>
        {% endfor %}
        </ul>
      {% else %}
        <p>ä½ å°šæœªäº¤ä»˜ä»»ä½•æª”æ¡ˆã€‚</p>
      {% endif %}
    </div>

  {% elif user.user_type.strip() == 'contractor' and project.status.strip() == 'open' %}
    {% if has_bid or my_bid %}
      <div class="already-bid">
        <h2>âœ… ä½ å·²æŠ•æ¨™æ­¤å°ˆæ¡ˆ</h2>
        <p>ä½ å·²ç¶“å°æ­¤å°ˆæ¡ˆæäº¤éå ±åƒ¹,<strong>ç„¡æ³•é‡è¤‡æŠ•æ¨™</strong>ã€‚</p>
        
        {% if my_bid %}
        <div class="info-box">
          <p><strong>ä½ çš„å ±åƒ¹:</strong> ${{ "%.2f"|format(my_bid['price']) }}</p>
          <p><strong>ææ¡ˆèªªæ˜:</strong> {{ my_bid['message'] or '(ç„¡)' }}</p>
          
          {% if my_bid.proposal_url %}
          <p>
            <strong>è¨ˆç•«æ›¸:</strong> 
            <a href="{{ my_bid.proposal_url }}" target="_blank">
              ğŸ“„ é»æ­¤æª¢è¦–å·²ä¸Šå‚³çš„è¨ˆåŠƒæ›¸ (PDF)
            </a>
          </p>
          {% endif %}

          <p><strong>æŠ•æ¨™ç‹€æ…‹:</strong> 
            {% if my_bid['status'] == 'pending' %}
              <span style="color: #ff9800;">â³ ç­‰å¾…å§”è¨—äººå¯©æ ¸</span>
            {% elif my_bid['status'] == 'accepted' %}
              <span style="color: #4caf50;">âœ… å·²å¾—æ¨™</span>
            {% elif my_bid['status'] == 'rejected' %}
              <span style="color: #f44336;">âŒ æœªå¾—æ¨™</span>
            {% else %}
              {{ my_bid['status'] }}
            {% endif %}
          </p>
        </div>
        {% endif %}
        
        <p style="margin-top: 15px;">
          <a href="/contractor/my-bids" style="color: #2e7d32; font-weight: bold;">â†’ å‰å¾€ã€Œæˆ‘çš„å°ˆæ¡ˆã€æŸ¥çœ‹æ‰€æœ‰æŠ•æ¨™</a>
        </p>
      </div>
      
    {% else %}
      <div class="bid-form">
        <h2>ğŸ’° æäº¤æˆ‘çš„å ±åƒ¹</h2>
        <form action="/project/{{ project.id }}/bid" method="post" enctype="multipart/form-data"> 
          <div>
            <label for="price">æˆ‘çš„å ±åƒ¹ ($):</label>
            <input type="number" id="price" name="price" step="0.01" min="0" placeholder="ä¾‹å¦‚: 3000.00" required>
          </div>

          <div style="margin-top: 15px;">
            <label for="proposal_file">ä¸Šå‚³è¨ˆç•«æ›¸ (é™ PDF):</label>
            <input type="file" id="proposal_file" name="proposal_file" accept=".pdf">
            <div class="warning-text">
              âš ï¸ **é‡è¦ï¼š** å»ºè­°ä¸Šå‚³æ‚¨çš„è©³ç´°è¨ˆåŠƒæ›¸ (.pdf) ä»¥å¢åŠ ææ¡ˆæˆåŠŸç‡ã€‚
            </div>
          </div>
          
          <div style="margin-top: 15px;">
            <label for="message">ææ¡ˆèªªæ˜ (é¸å¡«):</label>
            <textarea id="message" name="message" rows="5" placeholder="è«‹ç°¡çŸ­èªªæ˜ä½ çš„æœå‹™å…§å®¹ã€å„ªå‹¢ã€é è¨ˆäº¤ä»˜æ™‚é–“ç­‰..."></textarea>
          </div>
          
          <button type="submit" style="margin-top: 15px;">æäº¤å ±åƒ¹</button>
        </form>
        
        <div class="warning-text">
          âš ï¸ <strong>æ³¨æ„:</strong> æ¯å€‹å°ˆæ¡ˆåªèƒ½æŠ•æ¨™ä¸€æ¬¡,é€å‡ºå¾Œç„¡æ³•ä¿®æ”¹,è«‹è¬¹æ…å¡«å¯«å ±åƒ¹èˆ‡èªªæ˜ã€‚
        </div>
      </div>
    {% endif %}
  
  {% elif project.status.strip() != 'open' %}
    <div class="info-box">
      <p><strong>æ­¤å°ˆæ¡ˆå·²çµæ¡ˆæˆ–æ­£åœ¨é€²è¡Œä¸­,ç„¡æ³•æŠ•æ¨™ã€‚</strong></p>
    </div>
  
  {% endif %}

  <hr>
  <div style="text-align:center; margin-top: 20px;">
    <button onclick="window.history.back()" 
            style="background-color: var(--theme); color: white; border: none; border-radius: 10px;
                   padding: 10px 18px; font-size: 16px; font-weight: bold; cursor: pointer;
                   transition: background 0.3s;">
      â¬… è¿”å›ä¸Šä¸€é 
    </button>
  </div>

</main>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯
        const errorDetail = '{{ request.query_params.get("error_detail", "") }}';
        
        if (errorDetail) {
             // è™•ç†éŒ¯èª¤ï¼šåªé¡¯ç¤ºå½ˆçª—
             const decodedError = decodeURIComponent(errorDetail.replace(/\+/g, ' '));
             alert(`æ“ä½œå¤±æ•—ï¼š${decodedError}`);
        }
    });
</script>

</body>
</html>