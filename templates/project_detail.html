<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>æš¨æŸ´å·¥ä½œå§”è¨—å¹³å°</title>
<style>
  :root {
    --pink: #FFB7C3;
    --pink-light: #FFE4E1;
    --theme: #FF5E7E;
    --gray: #f4f4f4;
    --text: #333;
  }
  body { font-family: "Noto Sans TC", sans-serif; background-color: var(--pink-light); color: var(--text); margin: 0; padding: 0; }
  header { background-color: var(--pink); color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  header a { color: white; text-decoration: none; font-weight: bold; }
  header a:hover { text-decoration: underline; }
  /* æ–°å¢ï¼šå¤–å±¤å®¹å™¨ */
.page-container {
  max-width: 1400px;
  margin: 40px auto;
  padding: 0 20px;
  display: flex;          /* ğŸ‘ˆ ä½¿ç”¨ Flexbox */
  gap: 30px;              /* ğŸ‘ˆ å·¦å³é–“è· */
  align-items: flex-start;
}

/* å·¦å´ä¸»å…§å®¹å€ */
.main-content {
  flex: 1;                /* ğŸ‘ˆ ä½”æ“šå‰©é¤˜ç©ºé–“ */
  min-width: 0;
  background-color: white;
  border-radius: 15px;
  padding: 40px 50px;     /* ğŸ‘ˆ å…§è·å¢åŠ  */
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* æ–°å¢ï¼šå³å´è©•åƒ¹å¡ç‰‡ */
.reputation-card {
  flex: 0 0 320px;        /* ğŸ‘ˆ å›ºå®šå¯¬åº¦ 320px */
  background-color: white;
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  position: sticky;       /* ğŸ‘ˆ å›ºå®šå®šä½ */
  top: 20px;
  text-align: left;
  max-height: calc(100vh - 60px); /* ğŸ‘ˆ æ–°å¢ï¼šé™åˆ¶é«˜åº¦ */
  overflow-y: auto;
}

.reputation-card .role-badge {
  display: inline-block;
  background-color: var(--pink);
  color: white;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.75em;
}

/* ğŸ‘ˆ æ–°å¢ï¼šéš±è—æ»¾å‹•æ¢ */
.reputation-card::-webkit-scrollbar {
  width: 0;
  display: none;
}


/* ğŸ†• é ­åƒå’ŒåŸºæœ¬è³‡è¨Šå€åŸŸ - æ©«å‘æ’åˆ— */
  .profile-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 2px solid #eee;
  }

  .reputation-card .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid var(--pink-light);
    flex-shrink: 0;
  }

  /* ğŸ†• å³å´è³‡è¨Šå€ */
  .profile-info {
    flex: 1;
  }

  .client-name {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--text);
    margin: 0 0 5px 0;
  }

/* è©•åˆ†æ¢ç›®å€ */
.score-item {
  margin-bottom: 12px;
}

.score-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.85em;
  margin-bottom: 5px;
  color: #666;
}

/* è©•åˆ†æ‘˜è¦å€ */
.score-summary {
  margin-bottom: 15px;
}

.reputation-card .big-score {
  font-size: 2em;
  font-weight: bold;
  color: var(--theme);
  margin: 0;
  line-height: 1;
}

.reputation-card .star-display {
  color: #f1c40f;
  font-size: 1em;
  margin: 5px 0;
}

.reputation-card .total-reviews {
  color: #888;
  font-size: 0.85em;
  margin: 0 0 15px 0;
}

.reputation-card .score-bars {
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
  margin-bottom: 15px;
}


/* è©•è«–é è¦½å€ */
.reviews-preview {
  margin-top: 15px;
}

.preview-title {
  font-size: 0.9em;
  font-weight: bold;
  color: var(--text);
  margin-bottom: 10px;
}

.review-preview-item {
  background: var(--pink-light);
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 0.85em;
}

.review-preview-item .review-stars-small {
  color: #f1c40f;
  font-size: 0.9em;
  margin-bottom: 3px;
}

.review-preview-item .review-comment {
  color: #555;
  font-style: italic;
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.progress-bg {
  background: #f0f0f0;
  height: 6px;
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  background: var(--theme);
  height: 100%;
  border-radius: 3px;
  transition: width 0.5s ease;
}

.view-all-btn {
  margin-top: 20px;
  padding: 10px 20px;
  background-color: var(--theme);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9em;
  transition: background 0.3s;
}

.view-all-btn:hover {
  background-color: #ff7b9d;
}
  h1 { color: var(--theme); margin-top: 0; }
  h2, h3 { color: var(--theme); }
  .project-meta { background-color: #fff6f8; border: 1px solid #f2c7d1; border-radius: 10px; padding: 20px; margin-top: 10px; }
  .project-meta p { margin: 6px 0; }
  .project-meta a { color: var(--theme); text-decoration: none; }
  .project-meta a:hover { text-decoration: underline; }
  .bid-form { margin-top: 30px; background-color: #fdf2f5; border-radius: 10px; padding: 20px 30px; border: 1px solid #f4c4d3; }
  .bid-form h2 { margin-top: 0; color: var(--theme); }
  .already-bid { margin-top: 30px; background-color: #e8f5e9; border-radius: 10px; padding: 20px 30px; border: 1px solid #4caf50; }
  .already-bid h2 { margin-top: 0; color: #2e7d32; }
  .info-box { background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 15px 20px; margin: 15px 0; }
  .info-box p { margin: 8px 0; color: #856404; }
  .info-box strong { color: #664d03; }
  label { display: block; font-weight: bold; margin-bottom: 6px; }
  input[type="number"], input[type="file"], textarea { width: 100%; max-width: 400px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; outline: none; transition: border-color 0.3s; box-sizing: border-box; }
  input:focus, textarea:focus { border-color: var(--theme); }
  button { background-color: var(--theme); color: white; border: none; border-radius: 10px; padding: 12px 18px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.3s; }
  button:hover { background-color: #ff7b9d; }
  hr { border: 0; border-top: 1px solid #eee; margin: 25px 0; }
  .deliverables-list { margin-top: 20px; list-style-type: none; padding-left: 0; }
  .deliverables-list li { background: #f9f9f9; padding: 10px 15px; border-radius: 5px; margin-bottom: 8px; border: 1px solid #eee; }
  .deliverables-list small { color: #777; }
  .deliverables-list p { margin-left: 10px; font-style: italic; color: #555; margin-top: 5px; margin-bottom: 5px; }
  .warning-text { color: #666; font-size: 14px; margin-top: 10px; padding: 10px; background-color: #fff9e6; border-left: 3px solid #ffc107; border-radius: 5px; }
</style>
</head>
<body>

<header>
  <h2>ğŸ’¼ ææ¡ˆå¹³å°</h2>
  <a href="{% if user.user_type.strip() == 'contractor' %}/contractor/dashboard{% else %}/client/dashboard{% endif %}">è¿”å›å„€è¡¨æ¿</a>
</header>

<div class="page-container">
  <div class="main-content">
  <h1>{{ project.title }}</h1>

  <div class="project-meta">
    <p><strong>å§”è¨—äºº:</strong> {{ project.client_name.strip() }}</p>
    <p><strong>é ç®—:</strong> ${{ "%.2f"|format(project.budget) }}</p>
    <p><strong>ç‹€æ…‹:</strong> {{ project.status.strip() }}</p>
    <p><strong>æˆªæ­¢æ—¥æœŸ:</strong> {{ project.deadline.strftime('%Y-%m-%d') if project.deadline else 'N/A' }}</p>
  </div>
  
  <hr>
  
  <h3>ğŸ“‹ å°ˆæ¡ˆæè¿°</h3>
  <p>{{ project.description | safe | replace('\n', '<br>') }}</p>
  
  {% if project.attachment_url %}
  <p>
    <strong>å°ˆæ¡ˆé™„ä»¶:</strong>
    <a href="{{ project.attachment_url }}" target="_blank">
      ğŸ“ é»æ­¤ä¸‹è¼‰é™„ä»¶
    </a>
  </p>
  {% endif %}
  
  <hr>

  <!-- ========================================
       æŠ•æ¨™èˆ‡äº¤ä»˜é‚è¼¯ (âœ… åŠ å…¥é‡è¤‡æŠ•æ¨™æª¢æŸ¥)
       ======================================== -->

  {% if user.user_type.strip() == 'client' and user.uid == project.client_id %}
    <!-- 1. å§”è¨—äººçœ‹è‡ªå·±çš„å°ˆæ¡ˆ -->
    <div class="admin-links">
        <h2>ğŸ“Š å°ˆæ¡ˆç®¡ç†</h2>
        <p>é€™æ˜¯ä½ çš„å°ˆæ¡ˆ,ä½ å¯ä»¥ <a href="/client/project/{{ project.id }}/manage">é»æ­¤ç®¡ç†æŠ•æ¨™èˆ‡é©—æ”¶</a>ã€‚</p>
    </div>
  
  {% elif user.user_type.strip() == 'contractor' and project.status.strip() == 'in_progress' and user.uid == project.accepted_contractor_id %}
    <!-- 2. æ¥æ¡ˆäºº(å¾—æ¨™è€…)äº¤ä»˜æª”æ¡ˆ -->
    <div class="bid-form">
      <h2>ğŸ† äº¤ä»˜ä½ çš„æˆæœ</h2>
      
      {% if deliverables %}
        <p>ä»¥ä¸‹æ˜¯ä½ ã€Œå·²äº¤ä»˜/è¢«é€€ä»¶ã€çš„ç´€éŒ„:</p>
        <ul class="deliverables-list">
        {% for d in deliverables %}
          <li>
            <a href="{{ d.file_url }}" target="_blank">
              ğŸ“ {{ d.file_url.split('/')[-1] }}
            </a>
            <br>
            <small>ç‹€æ…‹: <strong style="color:red">{{ d.status.strip() }}</strong> ({{ d.created_at.strftime('%Y-%m-%d') }})</small>
            <p>"{{ d.note }}"</p>
          </li>
        {% endfor %}
        </ul>
        <hr>
        <p><strong>ä½ çš„æª”æ¡ˆè¢«é€€ä»¶äº†,è«‹é‡æ–°ä¸Šå‚³:</strong></p>
      {% else %}
        <p>æ­å–œä½ !ä½ æ˜¯é€™å€‹å°ˆæ¡ˆçš„å¾—æ¨™è€…ã€‚è«‹åœ¨æ­¤ä¸Šå‚³ä½ çš„çµæ¡ˆæª”æ¡ˆã€‚</p>
      {% endif %}

      <form action="/contractor/project/{{ project.id }}/deliver" method="post" enctype="multipart/form-data">
        <div>
          <label for="file">äº¤ä»˜æª”æ¡ˆ:</label>
          <input type="file" id="file" name="file" required>
        </div>
        <div>
          <label for="note">å‚™è¨» (é¸å¡«):</label>
          <textarea id="note" name="note" rows="4"></textarea>
        </div>
        <button type="submit">æäº¤æª”æ¡ˆ</button>
      </form>
    </div>
  
  {% elif user.user_type.strip() == 'contractor' and project.status.strip() not in ['open', 'in_progress'] and user.uid == project.accepted_contractor_id %}
    <!-- 3. æ¥æ¡ˆäºº(å¾—æ¨™è€…)æŸ¥çœ‹å·²çµæ¡ˆå°ˆæ¡ˆ -->
    <div class="bid-form">
      <h2>âœ… ä½ çš„äº¤ä»˜ç´€éŒ„</h2>
      <p>ä½ æ˜¯é€™å€‹å°ˆæ¡ˆçš„å¾—æ¨™è€…ã€‚ä»¥ä¸‹æ˜¯ä½ çš„äº¤ä»˜ç´€éŒ„:</p>
      
      {% if deliverables %}
        <ul class="deliverables-list">
        {% for d in deliverables %}
          <li>
            <a href="{{ d.file_url }}" target="_blank">
              ğŸ“ {{ d.file_url.split('/')[-1] }}
            </a>
            <br>
            <small>ç‹€æ…‹: <strong style="color:green">{{ d.status.strip() }}</strong> ({{ d.created_at.strftime('%Y-%m-%d') }})</small>
            <p>"{{ d.note }}"</p>
          </li>
        {% endfor %}
        </ul>
      {% else %}
        <p>ä½ å°šæœªäº¤ä»˜ä»»ä½•æª”æ¡ˆã€‚</p>
      {% endif %}
    </div>

  {% elif user.user_type.strip() == 'contractor' and project.status.strip() == 'open' %}
    <!-- 4. æ¥æ¡ˆäººæŠ•æ¨™å€åŸŸ (âœ… é‡é»ä¿®æ”¹:æª¢æŸ¥ has_bid æˆ– my_bid) -->
    
    {% if has_bid or my_bid %}
      <!-- âœ… å·²ç¶“æŠ•éæ¨™äº† -->
      <div class="already-bid">
        <h2>âœ… ä½ å·²æŠ•æ¨™æ­¤å°ˆæ¡ˆ</h2>
        <p>ä½ å·²ç¶“å°æ­¤å°ˆæ¡ˆæäº¤éå ±åƒ¹,<strong>ç„¡æ³•é‡è¤‡æŠ•æ¨™</strong>ã€‚</p>
        
        {% if my_bid %}
        <div class="info-box">
          <p><strong>ä½ çš„å ±åƒ¹:</strong> ${{ "%.2f"|format(my_bid['price']) }}</p>
          <p><strong>ææ¡ˆèªªæ˜:</strong> {{ my_bid['message'] or '(ç„¡)' }}</p>
          <p><strong>æŠ•æ¨™ç‹€æ…‹:</strong> 
            {% if my_bid['status'] == 'pending' %}
              <span style="color: #ff9800;">â³ ç­‰å¾…å§”è¨—äººå¯©æ ¸</span>
            {% elif my_bid['status'] == 'accepted' %}
              <span style="color: #4caf50;">âœ… å·²å¾—æ¨™</span>
            {% elif my_bid['status'] == 'rejected' %}
              <span style="color: #f44336;">âŒ æœªå¾—æ¨™</span>
            {% else %}
              {{ my_bid['status'] }}
            {% endif %}
          </p>
        </div>
        {% endif %}
        
        <p style="margin-top: 15px;">
          <a href="/contractor/my-bids" style="color: #2e7d32; font-weight: bold;">â†’ å‰å¾€ã€Œæˆ‘çš„å°ˆæ¡ˆã€æŸ¥çœ‹æ‰€æœ‰æŠ•æ¨™</a>
        </p>
      </div>
      
    {% else %}
      <!-- âœ… å°šæœªæŠ•æ¨™,é¡¯ç¤ºæŠ•æ¨™è¡¨å–® -->
      <div class="bid-form">
        <h2>ğŸ’° æäº¤æˆ‘çš„å ±åƒ¹</h2>
        <form action="/project/{{ project.id }}/bid" method="post">
          <div>
            <label for="price">æˆ‘çš„å ±åƒ¹ ($):</label>
            <input type="number" id="price" name="price" step="0.01" min="0" placeholder="ä¾‹å¦‚: 3000.00" required>
          </div>
          <div style="margin-top: 15px;">
            <label for="message">ææ¡ˆèªªæ˜ (é¸å¡«):</label>
            <textarea id="message" name="message" rows="5" placeholder="è«‹ç°¡çŸ­èªªæ˜ä½ çš„æœå‹™å…§å®¹ã€å„ªå‹¢ã€é è¨ˆäº¤ä»˜æ™‚é–“ç­‰..."></textarea>
          </div>
          <button type="submit" style="margin-top: 15px;">æäº¤å ±åƒ¹</button>
        </form>
        
        <div class="warning-text">
          âš ï¸ <strong>æ³¨æ„:</strong> æ¯å€‹å°ˆæ¡ˆåªèƒ½æŠ•æ¨™ä¸€æ¬¡,é€å‡ºå¾Œç„¡æ³•ä¿®æ”¹,è«‹è¬¹æ…å¡«å¯«å ±åƒ¹èˆ‡èªªæ˜ã€‚
        </div>
      </div>
    {% endif %}
  
  {% elif project.status.strip() != 'open' %}
    <!-- 5. å°ˆæ¡ˆå·²é—œé–‰ -->
    <div class="info-box">
      <p><strong>æ­¤å°ˆæ¡ˆå·²çµæ¡ˆæˆ–æ­£åœ¨é€²è¡Œä¸­,ç„¡æ³•æŠ•æ¨™ã€‚</strong></p>
    </div>
  
  {% endif %}

  <hr>
  <div style="text-align:center; margin-top: 20px;">
    <button onclick="window.history.back()" 
            style="background-color: var(--theme); color: white; border: none; border-radius: 10px;
                   padding: 10px 18px; font-size: 16px; font-weight: bold; cursor: pointer;
                   transition: background 0.3s;">
      â¬… è¿”å›ä¸Šä¸€é 
    </button>
  </div>
  </div>
  <!-- å³å´è©•åƒ¹å¡ç‰‡ -->
    <div class="reputation-card">
    <div class="profile-header">
      <img class="avatar" 
           src="https://ui-avatars.com/api/?name={{ project.client_name }}&background=random&size=120" 
           alt="Avatar">
      
      <div class="profile-info">
        <div class="client-name">{{ project.client_name.strip() }}</div>
        <div class="role-badge">ğŸ’¼ å§”è¨—äºº</div>
      </div>
    </div>
    <div class="score-summary">
      <div class="big-score">{{ client_stats.avg_score }}</div>
      <div class="star-display">â˜…â˜…â˜…â˜…â˜…</div>
      <div class="total-reviews">({{ client_stats.total_count }} å‰‡è©•åƒ¹)</div>
    </div>
    <div class="score-bars">
      <div class="score-item">
        <div class="score-label">
          <span>éœ€æ±‚åˆç†æ€§</span>
          <span>{{ client_stats.avg_score_1 }}</span>
        </div>
        {% set width_1 = (client_stats.avg_score_1 | float * 20) | round(1) %}
        <div class="progress-bg">
          <div class="progress-fill" style="width: {{ width_1 }}%;"></div>
        </div>
      </div>
      
      <div class="score-item">
        <div class="score-label">
          <span>é©—æ”¶é›£åº¦</span>
          <span>{{ client_stats.avg_score_2 }}</span>
        </div>
        {% set width_2 = (client_stats.avg_score_2 | float * 20) | round(1) %}
        <div class="progress-bg">
          <div class="progress-fill" style="width: {{ width_2 }}%;"></div>
        </div>
      </div>
      
      <div class="score-item">
        <div class="score-label">
          <span>åˆä½œæ…‹åº¦</span>
          <span>{{ client_stats.avg_score_3 }}</span>
        </div>
        {% set width_3 = (client_stats.avg_score_3 | float * 20) | round(1) %}
        <div class="progress-bg">
          <div class="progress-fill" style="width: {{ width_3 }}%;"></div>
        </div>
      </div>
    </div>

    <!-- ğŸ†• è©•è«–é è¦½ -->
    <div class="reviews-preview">
      <div class="preview-title">ğŸ“ æœ€è¿‘è©•åƒ¹</div>
      
      {% if client_reviews %}
        {% for review in client_reviews[:3] %}
        <div class="review-preview-item">
          {% set s1 = review.score_1|default(0)|int %}
          {% set s2 = review.score_2|default(0)|int %}
          {% set s3 = review.score_3|default(0)|int %}
          {% set avg = ((s1 + s2 + s3) / 3) | round(1) %}
          
          <div class="review-stars-small">â˜… {{ avg }}</div>
          <div class="review-comment">
            "{{ review.comment if review.comment else 'åˆä½œæ„‰å¿«' }}"
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div style="text-align: center; color: #999; padding: 20px; font-size: 0.85em;">
          å°šç„¡è©•åƒ¹ç´€éŒ„
        </div>
      {% endif %}
    </div>
    
    <a href="/profile/{{ project.client_id }}" target="_blank">
      <button class="view-all-btn">æŸ¥çœ‹å®Œæ•´è©•åƒ¹ â†’</button>
    </a>
  </div>
</div>

</body>
</html>